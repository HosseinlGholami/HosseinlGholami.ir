<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Put-to-Light v2: A Lights-First, API-Driven System for Faster, Simpler Item Sorting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --ink:#0f172a; --sub:#334155; --brand:#003366; --muted:#64748b; --pill:#eef2f7; --code:#f8fafc;
      --ok:#059669; --violet:#7c3aed; --blue:#2563eb; --border:#e5e7eb;
    }
    html,body{margin:0;padding:0;background:#fff;color:var(--ink);}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.8;padding:40px 28px;max-width:1100px;margin:auto;}
    h1,h2,h3,h4{color:var(--brand);line-height:1.3;margin-top:2rem}
    h1{font-size:2.1rem;margin-bottom:.5rem}
    h2{font-size:1.6rem}
    h3{font-size:1.2rem}
    p,li{color:var(--ink)}
    .lede{color:var(--sub);font-size:1.05rem}
    .caption{font-size:.9rem;color:var(--muted);text-align:center;margin:8px 0 28px}
    img{display:block;margin:18px auto;max-width:96%;border-radius:10px}
    pre,code{background:var(--code);border-radius:8px}
    pre{padding:14px 16px;overflow:auto}
    code.inline{padding:1px 6px}
    .grid-2{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    .kpis{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));margin:14px 0 4px}
    .kpi{background:var(--pill);border:1px solid var(--border);padding:16px;border-radius:12px;text-align:center}
    .kpi .val{font-weight:800;font-size:1.5rem}
    .kpi .lbl{color:var(--muted);font-size:.92rem}
    .note{background:#f8fafc;border-left:3px solid var(--brand);padding:12px 14px;border-radius:8px;color:var(--sub)}
    .table{width:100%;border-collapse:collapse;margin:10px 0 24px}
    .table th,.table td{border:1px solid var(--border);padding:10px 12px;text-align:left}
    .table th{background:#f1f5f9;color:#0b2545}
    .small{color:var(--muted);font-size:.9rem}
    hr{border:none;height:1px;background:var(--border);margin:28px 0}
    a{color:var(--blue);text-decoration:none}
  </style>
</head>
<body>

<!-- ───────────────────────────────────────────────────────────────────────────── -->
<!-- Title + Executive Summary -->
<h1>Put-to-Light v2: A Lights-First, API-Driven System for Faster, Simpler Item Sorting</h1>
<p class="lede">
  Put-to-Light (P2L) v2 is a deep re-architecture of our warehouse sorting assist system. Where v1 relied on
  per-box button nodes, v2 adopts <strong>continuous RGB LED strips</strong>, a tightly integrated
  <strong>Phoenix handheld experience</strong>, and a <strong>service-oriented (SaaS-like) backend</strong>.
  It’s cheaper to build and maintain, easier to scale to any shelving geometry, and—most importantly—faster for
  operators. This article details the system from operator flow and packet framing to firmware, APIs, monitoring,
  and measured performance.
</p>

<img src="/images/p2l-v2/p2l-dif.png" alt="P2L evolution from v1 buttons to v2 RGB strips">
<p class="caption">From buttoned AVR nodes (v1) to continuous RGB strips + Phoenix (v2).</p>

<!-- ───────────────────────────────────────────────────────────────────────────── -->
<h2>What’s New in v2 (vs v1)</h2>
<p>
In Put-to-Light version 1, each pigeonbox was equipped with five fixed-size LED indicators. These LEDs emitted only a limited amount of light, which often made it difficult for operators to quickly identify the correct signal during fast-paced sorting. In version 2, this limitation was eliminated by replacing the old design with <strong>continuous RGB LED strips</strong>. The strips produce a much larger and brighter light footprint, making them far easier to spot even from a distance, and improving guidance clarity for operators under pressure.
</p>

<p>
The mechanical design has also evolved. Version 1 relied on a fixed enclosure that required custom mechanical engineering for each type of shelf, which limited scalability and increased installation effort. In contrast, version 2 uses a modular LED strip design that can be flexibly mounted on any type of shelf without needing dedicated mechanical redesigns. The software control layer was also re-architected to be fully expandable, so LED strips of <em>any length</em> can be addressed and controlled dynamically. This was achieved by adopting <strong>WS2812 LED strips</strong>, which are IP65-rated, waterproof, shock-resistant, and durable enough for industrial environments.
</p>

<p>
The operator interface has also been completely redesigned. In version 1, operators relied on a standalone web application that communicated with Supernova through barcode lookups, and in many cases they still had to fall back on scanning pigeonbox barcodes. In version 2, the system is <strong>natively integrated into the Supernova handheld app</strong> — the same interface operators already use for other pigeon tasks in the WMS. This means there is no extra training or unfamiliar software: the P2L workflow appears seamlessly inside their daily tool. The backend communicates with Supernova through a set of lightweight, well-documented APIs, so the experience is consistent and simple. Once logged in, each operator is automatically assigned a unique color, and guidance is provided not only through the illuminated LED strip but also through contextual hints in the handheld UI, making the process both intuitive and reliable.
</p>

<p>
Another major difference is in cost and maintenance. The older design required more electronics per box 
and introduced multiple points of failure. With the v2 design, the system achieves approximately 
<strong>60% lower build cost</strong> by reducing component complexity, while also making the setup 
much easier to service and maintain.
</p>

<p>
Finally, the update process has been significantly streamlined. In version 1, although OTA was supported, the procedure was cumbersome and multi-layered. Updates had to be applied first to the <strong>ESP32 hubs</strong>, and then a second stage pushed firmware through the CAN bus to every <strong>AVR node</strong> connected downstream. This two-step process added complexity and increased the risk of errors during deployment. In version 2, the architecture is dramatically simplified: since there are no longer individual AVR nodes, administrators only need to update the <strong>hub board</strong> itself. Each hub, powered by an ESP32, downloads, verifies, and applies the new firmware in a single step. With the node layer eliminated, the system is not only easier to maintain but also much more expandable, making future deployments faster and far simpler to manage at scale.
</p>

<!-- ───────────────────────────────────────────────────────────────────────────── -->
<h2>Operator Workflow</h2>
<p>
When an operator enters a pigeon, the system automatically assigns them a unique color that will be used throughout their shift. The workflow begins when the operator scans an item using the Phoenix handheld app. Immediately, the LED strip segment corresponding to the correct pigeonbox lights up in their assigned color, making the destination instantly visible. The operator then places the item in the illuminated box. To confirm the action, they scan the barcode printed on the pigeonbox, which both acknowledges the put action in the backend and turns off the light. This cycle — scan, illuminate, place, confirm — is simple, fast, and designed for repetitive execution in high-volume environments. 
</p>

<p>
Because each operator has a unique color, multiple people can work on the same pigeon simultaneously without confusion. The Phoenix app also provides additional visual hints, such as red/blue coloring to indicate whether the target box lies in the left (1–90) or right (91–180) half of the pigeon, further reducing search time. 
</p>

<!-- Handheld Screenshot Placeholder -->
<img src="/images/p2l-v2/handheld-app.png" alt="Phoenix handheld screenshot during operator workflow">
<p class="caption">Phoenix handheld app: item scan → pigeonbox highlight → confirmation.</p>

<!-- Operator Demo GIF Placeholder -->
<img src="/images/p2l-v2/work-flow.gif" alt="Animated demo of operator workflow">
<p class="caption">Video demonstration: operator scanning, placing item, and confirming the pigeonbox.</p>

<!-- ───────────────────────────────────────────────────────────────────────────── -->
<h2>System Overview</h2>
<p>
In P2L v2, totes arrive to a 180-box pigeon while operators work entirely within the <strong>Supernova handheld</strong>. A scan triggers the backend to publish a <em>strip-on</em> command over MQTT; local <strong>ESP32 hubs</strong> fan out control to per-shelf <strong>switch boards</strong>, illuminating the <strong>RGB LED strip segment</strong> of the target box in the operator’s assigned color. A <strong>barcode confirm</strong> on the box closes the loop (turn-off + ack), feeding monitoring dashboards and KPIs. Because strips are modular (WS2812, IP65) and logic is OTA-updatable, the system is simpler to install, cheaper to maintain, and easy to expand across pigeons.
</p>

<!-- ───────────────────────────────────────────────────────────────────────────── -->
<h2>Architecture</h2>
<div class="grid-2">
  <div>
    <h3>Logical Flow</h3>
    <ol>
      <li>
        <strong>Phoenix (Handheld):</strong>
        Manages authentication, pigeon selection, and item scans.
        Each operator is automatically assigned a unique color, and the app provides side hints
        (red = boxes 1–90, blue = boxes 91–180).
      </li>
      <li>
        <strong>Backend (Django + Celery):</strong>
        Validates the scanned item and resolves the destination <code>hub</code>, the <code>strip_id</code>,
        and the number of LEDs assigned to that strip.
        If the strip is already active (because another operator is using the same pigeonbox),
        the system automatically splits the LEDs so both operators see guidance simultaneously.
        Celery workers publish MQTT commands to the target hub and wait for an ACK; on timeout they retry or raise an error event.
        In parallel, Celery records end-to-end timings and device latencies (scan→publish, publish→ACK, scan→scan, etc.)
        to <strong>InfluxDB</strong>. A dedicated <strong>Grafana</strong> dashboard visualizes KPIs (latency percentiles,
        error rates, hub timeouts) and warehouse operator metrics such as <em>average scan-to-scan time</em> and throughput per shift.
      </li>
      <li>
        <strong>Hub (ESP32):</strong>
        Subscribes to its dedicated MQTT topic, decodes incoming packets, and selects the correct shelf channel on its switch board.
        It drives the assigned RGB LED strip segment accordingly and publishes back an ACK or error to close the control loop.
      </li>
    </ol>
  </div>
  <div>
    <h3>Physical Topology</h3>
    <p>
      Each <strong>pigeon</strong> contains 180 pigeonboxes. To cover this capacity, the design uses
      <strong>4 ESP32 hubs</strong> per pigeon. Each hub is connected to <strong>3 switch boards</strong>,
      and together they control <strong>45 LED strips</strong> (pigeonboxes) per hub.
      This modular distribution ensures scalability, fault isolation, and balanced load across the pigeon.
    </p>
    <ul>
      <li>
        <strong>Hubs:</strong> ESP32-based controllers with Wi-Fi, TLS, and OTA support.
        Each hub drives 45 strips and communicates with 3 dedicated switch boards.
      </li>
      <li>
        <strong>Switch Boards:</strong> Per-shelf fan-out modules (~15 pigeonboxes per shelf),
        built with <em>4→16 multiplexers</em>. Each provides 15 active lines plus one reserved for diagnostics or expansion.
      </li>
      <li>
        <strong>LED Strip Carriers:</strong> Industrial-grade WS2812 RGB LED strips (IP65-rated, waterproof and shock-resistant),
        mounted on aluminum profiles riveted to shelf fronts for durability and easy servicing.
      </li>
      <li>
        <strong>Cabling:</strong> Standardized 3-wire (power + data) harnesses, routed consistently across shelves and pigeons
        for predictable installation and simplified troubleshooting.
      </li>
    </ul>
  </div>
</div>

<img src="/images/p2l-v2/p2l-v2-arch.png"
     alt="Overall server architecture"
     loading="lazy">
<p class="caption">Overall technology arrangement.</p>

<img src="/images/p2l-v2/hub.png"
     alt="ESP32-based hub to switch boards and LED strip outputs"
     loading="lazy">
<p class="caption">Single ESP32-based hub package interfacing to shelf switch boards and LED strip connectors.</p>

<!-- ───────────────────────────────────────────────────────────────────────────── -->
<h2>Electronics & Embedded Software</h2>

<h3>Hub MCU (ESP32)</h3>
<ul>
  <li>
    The <strong>ESP32</strong> dual-core MCU provides Wi-Fi connectivity to the MQTT broker and supports OTA firmware updates. 
    Its <strong>GPIOs</strong> drive the multiplexers on each switch board, while the <strong>RMT peripheral</strong> generates precise 
    timing signals for the WS2812 RGB LED strips.
  </li>
  <li>
    Core tasks under FreeRTOS include Wi-Fi & parameter initialization, server communication (MQTT uplink/ack handling), 
    strip control (GPIO select + RMT LED rendering), and OTA management (fetch, validate, apply).
  </li>
</ul>

<h3>Shelf Switch Boards</h3>
<ul>
  <li>
    Each board integrates a <strong>GPIO-controlled multiplexer</strong> that fans out up to 16 LED strip outputs. 
    With three boards per hub, a single hub manages ~48 strips (depending on configuration). 
    Boards also include fused power rails and guarded signal routing for noise resilience.
  </li>
</ul>

<img src="/images/p2l-v2/pcb.png" alt="Hub and switch board PCB layout" loading="lazy">
<p class="caption">Custom PCBs: ESP32-based hub (left) and a switch board (right) with a GPIO-controlled multiplexer. 
The RMT peripheral guarantees accurate WS2812 timing.</p>

<!-- ───────────────────────────────────────────────────────────────────────────── -->
<h2>Packet Structure & Messaging</h2>
<p>
  Communication between backend and hubs uses a lightweight MQTT layer with compact binary packets. 
  Each command has a <strong>10-byte base header</strong> (2-bit version + 6-bit type, 64-bit timestamp, 1-byte target) 
  plus up to 4 optional bytes for parameters. Supported types include 
  <code class="inline">GET</code>, <code class="inline">SET</code>, <code class="inline">HBT</code>, 
  <code class="inline">REP</code>, <code class="inline">CMD</code>, <code class="inline">PING-PONG</code>, 
  and <code class="inline">WILL</code>.
</p>
<p>
  Hubs subscribe to scoped MQTT topics such as <code class="inline">.p2l.hub.{id}</code> for control 
  and reply with ACKs on <code class="inline">.p2l.hub.rpl.{id}</code>. 
  The backend manages retries.
</p>

<img src="/images/p2l-v2/header.png" alt="Binary packet header structure" loading="lazy">
<p class="caption">Compact header ensures low-latency communication.</p>

<!-- ───────────────────────────────────────────────────────────────────────────── -->

<h2>Backend & Services</h2>
<p>
While the <em>Architecture</em> section explained the logical data flow between handhelds, backend, and hubs, 
this part looks deeper into the backend infrastructure, persistence layer, and monitoring stack that make 
Put-to-Light v2 reliable and observable. These services not only drive real-time strip control but also 
power the <strong>control panel</strong> (live page, service mode, config UI) and feed analytics into <strong>Grafana</strong>.
</p>

<ul>
  <li>
    <strong>Django Backend:</strong> The heart of the system. It exposes REST APIs for login, validation, 
    and strip control, while integrating with <strong>Supernova</strong> for inventory and operator workflows.
  </li>
  <li>
    <strong>Celery + RabbitMQ:</strong> Handle asynchronous MQTT publishing, retries, and timeout handling. 
    Every request is measured end-to-end (<em>scan → publish → hub ACK → clear</em>) and logged for performance analysis.
  </li>
  <li>
    <strong>Redis:</strong> Keeps real-time state of who is logged in, which pigeonboxes are lit, and ensures 
    that duplicate activations don’t confuse operators when multiple users share a pigeon.
  </li>
  <li>
    <strong>MySQL:</strong> Stores pigeons, hubs, switch mappings, and history of strip events, forming the 
    structured data model for long-term consistency.
  </li>
  <li>
    <strong>InfluxDB + Grafana:</strong> Metrics on latency, hub responsiveness, and operator cycle time are 
    stored in InfluxDB and visualized in Grafana dashboards — bridging engineering diagnostics with 
    operational KPIs for managers.
  </li>
</ul>

<img src="/images/p2l-v2/db-sch.png" alt="Database schema overview" loading="lazy">
<p class="caption">Schema: pigeons, hubs, switches, and strip mappings form the system’s backbone.</p>

<!-- ───────────────────────────────────────────────────────────────────────────── -->
<h2>APIs</h2>
<p>
The backend is fully API-driven. A <strong>Swagger UI</strong> makes it easy for developers and integrators 
to explore available endpoints. The same APIs also power the <strong>control panel</strong>, which operators 
and engineers use daily to monitor pigeons and hubs, trigger service tests, and apply OTA updates.
</p>

<h3>Authentication & User</h3>
<ul>
  <li><code>POST /auth/login/</code> — obtain access/refresh tokens</li>
  <li><code>POST /auth/jwt/refresh/</code> — refresh an expired token</li>
  <li><code>POST /auth/jwt/verify/</code> — verify token validity</li>
  <li><code>GET  /auth/users/me/</code> — fetch current user profile</li>
</ul>

<h3>Device & Hub Management</h3>
<ul>
  <li><code>POST /put-to-light/api/check-hbt/</code> — verify hub heartbeat</li>
  <li><code>POST /put-to-light/api/do-ota/</code> — trigger OTA update for a hub</li>
  <li><code>SET  /put-to-light/api/hub-parameters/</code> — set current hub configuration</li>
  <li><code>GET  /put-to-light/api/hub-parameters/</code> — read current hub configuration</li>
  <li><code>GET  /put-to-light/api/locations/</code> — list pigeons, hubs, and pigeonboxes</li>
</ul>

<h3>Strips & Control</h3>
<ul>
  <li><code>GET  /put-to-light/api/list-active-strip/</code> — all currently active strips (used by live page)</li>
  <li><code>POST /put-to-light/api/strip-controller/</code> — turn a strip on/off for a given pigeonbox and operator color</li>
</ul>


<img src="/images/p2l-v2/api-sample.png" alt="Swagger API sample" loading="lazy">
<p class="caption">Swagger UI: strip-controller endpoint, showing on/off control with clear error codes (400(wrong input)/409(the last color dosent turned off)).</p>



<!-- ───────────────────────────────────────────────────────────────────────────── -->
<h2>Control Panel in Action</h2>
<p>
The control panel is the daily interface for both operators and engineers. It surfaces API data 
in real time and presents it in intuitive dashboards. From monitoring pigeons and hubs to 
configuring hardware or triggering diagnostic tests, the control panel provides a single 
window into the state of the system.
</p>

<h3>Live Page</h3>
<p>
The Live Page is used by supervisors and shift managers to see the current status of every 
pigeon. Each hub reports its IP address and online status, while active strips are shown 
with the operator’s assigned colors. This page allows quick triage during busy shifts: 
if an operator reports that a light did not trigger, the supervisor can instantly check 
whether the strip is active, which hub controls it, and whether the hub itself is online. 
This reduces downtime and avoids manual troubleshooting.
</p>
<div style="display:flex; justify-content:center; margin:25px 0;">
  <img src="/images/p2l-v2/live.JPG" alt="Live dashboard of pigeons, hubs, and strips" style="max-width:80%; border-radius:10px;">
</div>

<h3>Config UI</h3>
<p>
The Config UI provides engineers with fine-grained control over hub parameters. Settings 
such as LED brightness, light density, and pigeon-to-hub mappings can be adjusted without 
deploying new code. Parameters are stored centrally in the backend, ensuring consistency 
across hubs. This makes the system highly adaptable: shelves can be reconfigured or 
expanded, and hubs can be tuned to specific lighting conditions on the warehouse floor.
</p>
<div style="display:flex; justify-content:center; margin:25px 0;">
  <img src="/images/p2l-v2/config.JPG" alt="Hub config panel" style="max-width:80%; border-radius:10px;">
</div>

<h3>Service Mode</h3>
<p>
Service Mode is designed for technicians. It allows batch-illumination of a range of boxes, 
making it easy to test wiring after installation or to identify and replace faulty modules. 
For example, an engineer can turn on boxes 1–90 in blue and visually confirm that every 
strip responds. The same interface also integrates the OTA widget, so firmware updates can 
be triggered while performing diagnostics. This mode ensures that maintenance can be carried 
out without disrupting ongoing warehouse operations.
</p>
<div style="display:flex; justify-content:center; margin:25px 0;">
  <img src="/images/p2l-v2/service.JPG" alt="Service mode view" style="max-width:80%; border-radius:10px;">
</div>

<div style="display:flex; justify-content:center; margin:25px 0;">
  <video controls autoplay muted loop style="max-width:80%; border-radius:10px;">
    <source src="/images/p2l-v2/demo.mp4" type="video/mp4">
    Your browser does not support the video tag.
  </video>
</div>
<p class="caption">Demo: testing the range-illumination option in Service Mode.</p>

<!-- ───────────────────────────────────────────────────────────────────────────── -->
<h2>Monitoring & Analytics</h2>
<p>
Every operator scan, hub ACK, and API call contributes to a growing dataset. 
Celery logs timing metrics into InfluxDB, and Grafana visualizes both system reliability 
and warehouse efficiency. Engineers use it for latency and error tracking; managers use it 
for throughput and operator productivity.
</p>

<ul>
  <li><strong>Latency:</strong> Scan-to-scan, hub ACK time, MQTT publish delay</li>
  <li><strong>KPIs:</strong> Items/hour, operator speed</li>
</ul>

<img src="/images/p2l-v2/grafana-1.JPG" alt="Grafana operator KPIs" loading="lazy">
<img src="/images/p2l-v2/grafana-2.JPG" alt="Grafana API latancy" loading="lazy">
<p class="caption">Grafana dashboards: linking technical metrics with operator KPIs in one view.</p>

<p>
Together, the backend, APIs, control panel, and Grafana ecosystem turn 
Put-to-Light v2 into more than just a light-guidance system — it becomes 
a fully observable service platform for both engineers and warehouse operators.
</p>

<!-- ───────────────────────────────────────────────────────────────────────────── -->
<h2>Load & Stress Testing</h2>
<p>
Before production rollout, we validated system stability with synthetic stress tests simulating a 
worst-case of <strong>36 pigeons</strong> and <strong>6 operators per pigeon</strong>, compared against the 
typical 16 active pigeons and the initial pilot on two units (19 and 21). Each simulated operator thread 
randomly selected a pigeonbox, illuminated it for <strong>0.5–2 seconds</strong>, cleared it, then paused for 
<strong>1–2 seconds</strong>, creating a bursty workload similar to peak warehouse shifts. Under active load on pigeons 
19 and 21, response latency measured <em>33 ms minimum</em>, <em>61 ms average</em>, and <em>266 ms maximum</em>, while 
idle baselines were <em>20/30/144 ms</em> respectively. Server utilization remained efficient, holding around 
<em>10% CPU</em> in normal conditions and rising to only <em>~30% CPU</em> under peak synthetic load, confirming the 
system’s ability to maintain low-latency performance and moderate resource consumption even under exaggerated stress.
</p>


<!-- ───────────────────────────────────────────────────────────────────────────── -->
<h2>Measured Results & Targets</h2>
<ul>
  <li>
    <strong>Pilot (6 pigeons, 14 days):</strong> Delivered a consistent <em>4.9–5.5% overall throughput improvement</em>, 
    with peaks of up to <em>6.9%</em> in mixed fixed+flex scenarios. The largest productivity gains were observed 
    among new hires, confirming that the guidance system reduces training time and speeds up ramp-up.
  </li>
  <li>
    <strong>Program Targets:</strong> Aim for a sustained <em>0.7 seconds faster per item</em> (~<em>6.4% improvement</em>), 
    with as much as <em>20% efficiency gains</em> for new and flex operators. At scale, this translates into an 
    estimated <strong>777M IRR annual savings</strong> (≈<em>2.4 FTE equivalent</em>) across just six pigeons.
  </li>
</ul>

<!-- ───────────────────────────────────────────────────────────────────────────── -->
<h2>Conclusion</h2>
<p>
Put-to-Light v2 transforms warehouse guidance into a fast, intuitive, and scalable light-driven system. 
By replacing per-box buttons with continuous RGB strips and embedding the entire operator workflow inside Phoenix, 
we have removed friction from one of the most repetitive steps in outbound operations. The platform is 
<em>modular</em>, <em>OTA-updatable</em>, and <em>API-driven</em>, delivering measurable efficiency gains for new and 
flex operators while dramatically reducing build and maintenance costs. Backed by real-time monitoring, a simple 
service model, and actionable analytics, P2L v2 is ready to scale confidently across pigeons and fulfillment sites— 
and to keep evolving with future needs.
</p>


<hr />
<p class="small">
  <strong>Title:</strong> A Deep Dive into Put-to-Light v2<br/>
  <strong>Subtitle:</strong> From RGB-guided LEDs and Phoenix integration to measurable throughput gains
</p>

</body>
</html>
